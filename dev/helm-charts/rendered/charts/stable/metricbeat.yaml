---
# Source: metricbeat/templates/secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: RELEASE-NAME-metricbeat-daemonset-config
  labels:
    app: metricbeat
    chart: metricbeat-0.4.0
    release: RELEASE-NAME
    heritage: Tiller
type: Opaque
data:
  metricbeat.yml: ICAgIG1ldHJpY2JlYXQuY29uZmlnOgogICAgICBtb2R1bGVzOgogICAgICAgIHBhdGg6ICR7cGF0aC5jb25maWd9L21vZHVsZXMuZC8qLnltbAogICAgICAgIHJlbG9hZC5lbmFibGVkOiBmYWxzZQogICAgb3V0cHV0LmZpbGU6CiAgICAgIGZpbGVuYW1lOiBtZXRyaWNiZWF0CiAgICAgIG51bWJlcl9vZl9maWxlczogNQogICAgICBwYXRoOiAvdXNyL3NoYXJlL21ldHJpY2JlYXQvZGF0YQogICAgICByb3RhdGVfZXZlcnlfa2I6IDEwMDAwCiAgICBwcm9jZXNzb3JzOgogICAgLSBhZGRfY2xvdWRfbWV0YWRhdGE6IG51bGwKICAgIA==
---
apiVersion: v1
kind: Secret
metadata:
  name: RELEASE-NAME-metricbeat-deployment-config
  labels:
    app: metricbeat
    chart: metricbeat-0.4.0
    release: RELEASE-NAME
    heritage: Tiller
type: Opaque
data:
  metricbeat.yml: ICAgIG1ldHJpY2JlYXQuY29uZmlnOgogICAgICBtb2R1bGVzOgogICAgICAgIHBhdGg6ICR7cGF0aC5jb25maWd9L21vZHVsZXMuZC8qLnltbAogICAgICAgIHJlbG9hZC5lbmFibGVkOiBmYWxzZQogICAgb3V0cHV0LmZpbGU6CiAgICAgIGZpbGVuYW1lOiBtZXRyaWNiZWF0CiAgICAgIG51bWJlcl9vZl9maWxlczogNQogICAgICBwYXRoOiAvdXNyL3NoYXJlL21ldHJpY2JlYXQvZGF0YQogICAgICByb3RhdGVfZXZlcnlfa2I6IDEwMDAwCiAgICBwcm9jZXNzb3JzOgogICAgLSBhZGRfY2xvdWRfbWV0YWRhdGE6IG51bGwKICAgIA==
---
apiVersion: v1
kind: Secret
metadata:
  name: RELEASE-NAME-metricbeat-daemonset-modules
  labels:
    app: metricbeat
    chart: metricbeat-0.4.0
    release: RELEASE-NAME
    heritage: Tiller
type: Opaque
data:
      kubernetes.yml: ICAgIC0gaG9zdHM6CiAgICAgIC0gbG9jYWxob3N0OjEwMjU1CiAgICAgIG1ldHJpY3NldHM6CiAgICAgIC0gbm9kZQogICAgICAtIHN5c3RlbQogICAgICAtIHBvZAogICAgICAtIGNvbnRhaW5lcgogICAgICAtIHZvbHVtZQogICAgICBtb2R1bGU6IGt1YmVybmV0ZXMKICAgICAgcGVyaW9kOiAxMHMKICAgIA==
      system.yml: ICAgIC0gbWV0cmljc2V0czoKICAgICAgLSBjcHUKICAgICAgLSBsb2FkCiAgICAgIC0gbWVtb3J5CiAgICAgIC0gbmV0d29yawogICAgICAtIHByb2Nlc3MKICAgICAgLSBwcm9jZXNzX3N1bW1hcnkKICAgICAgbW9kdWxlOiBzeXN0ZW0KICAgICAgcGVyaW9kOiAxMHMKICAgICAgcHJvY2Vzcy5pbmNsdWRlX3RvcF9uOgogICAgICAgIGJ5X2NwdTogNQogICAgICAgIGJ5X21lbW9yeTogNQogICAgICBwcm9jZXNzZXM6CiAgICAgIC0gLioKICAgIC0gbWV0cmljc2V0czoKICAgICAgLSBmaWxlc3lzdGVtCiAgICAgIC0gZnNzdGF0CiAgICAgIG1vZHVsZTogc3lzdGVtCiAgICAgIHBlcmlvZDogMW0KICAgICAgcHJvY2Vzc29yczoKICAgICAgLSBkcm9wX2V2ZW50LndoZW4ucmVnZXhwOgogICAgICAgICAgc3lzdGVtLmZpbGVzeXN0ZW0ubW91bnRfcG9pbnQ6IF4vKHN5c3xjZ3JvdXB8cHJvY3xkZXZ8ZXRjfGhvc3R8bGliKSgkfC8pCiAgICA=
---
apiVersion: v1
kind: Secret
metadata:
  name: RELEASE-NAME-metricbeat-deployment-modules
  labels:
    app: metricbeat
    chart: metricbeat-0.4.0
    release: RELEASE-NAME
    heritage: Tiller
type: Opaque
data:
      kubernetes.yml: ICAgIC0gaG9zdHM6CiAgICAgIC0ga3ViZS1zdGF0ZS1tZXRyaWNzOjgwODAKICAgICAgbWV0cmljc2V0czoKICAgICAgLSBzdGF0ZV9ub2RlCiAgICAgIC0gc3RhdGVfZGVwbG95bWVudAogICAgICAtIHN0YXRlX3JlcGxpY2FzZXQKICAgICAgLSBzdGF0ZV9wb2QKICAgICAgLSBzdGF0ZV9jb250YWluZXIKICAgICAgbW9kdWxlOiBrdWJlcm5ldGVzCiAgICAgIHBlcmlvZDogMTBzCiAgICA=

---
# Source: metricbeat/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: RELEASE-NAME-metricbeat
  labels:
    app: metricbeat
    chart: metricbeat-0.4.0
    release: RELEASE-NAME
    heritage: Tiller
---
# Source: metricbeat/templates/clusterrole.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: RELEASE-NAME-metricbeat
  labels:
    app: metricbeat
    chart: metricbeat-0.4.0
    release: RELEASE-NAME
    heritage: Tiller
rules:
- apiGroups: [""]
  resources:
  - nodes
  - namespaces
  - events
  - pods
  verbs: ["get", "list", "watch"]
- apiGroups: ["extensions"]
  resources:
  - replicasets
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources:
  - statefulsets
  - deployments
  verbs: ["get", "list", "watch"]
---
# Source: metricbeat/templates/clusterrolebinding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: RELEASE-NAME-metricbeat
  labels:
    app: metricbeat
    chart: metricbeat-0.4.0
    release: RELEASE-NAME
    heritage: Tiller
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: RELEASE-NAME-metricbeat
subjects:
- kind: ServiceAccount
  name: RELEASE-NAME-metricbeat
  namespace: hub
---
# Source: metricbeat/templates/daemonset.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: RELEASE-NAME-metricbeat
  labels:
    app: metricbeat
    chart: metricbeat-0.4.0
    release: RELEASE-NAME
    heritage: Tiller
spec:
  selector:
    matchLabels:
      app: metricbeat
      release: RELEASE-NAME
  minReadySeconds: 10
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  template:
    metadata:
      labels:
        app: metricbeat
        release: RELEASE-NAME
      annotations:
        checksum/daemonset: c249feec6a27b8004887fde63266bc27df58b3ee4115a9426ff0430a1046d2b9
        checksum/config: 10339e54ffd45e5b6103e4c2b0fb457137c7ee00e75fafa54316539b73fe02f4
    spec:
      containers:
      - name: metricbeat
        image: "docker.elastic.co/beats/metricbeat:6.5.1"
        imagePullPolicy: IfNotPresent
        args:
        - "-e"
        - "-system.hostfs=/hostfs"
        env:
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        securityContext:
          runAsUser: 0
        resources:
          {}
          
        volumeMounts:
        - name: config
          mountPath: /usr/share/metricbeat/metricbeat.yml
          readOnly: true
          subPath: metricbeat.yml
        - name: modules
          mountPath: /usr/share/metricbeat/modules.d
          readOnly: true
        - name: data
          mountPath: /usr/share/metricbeat/data
        - name: proc
          mountPath: /hostfs/proc
          readOnly: true
        - name: cgroup
          mountPath: /hostfs/sys/fs/cgroup
          readOnly: true
        - name: dockersock
          mountPath: /var/run/docker.sock
      volumes:
      - name: config
        secret:
          secretName: RELEASE-NAME-metricbeat-daemonset-config
      - name: modules
        secret:
          secretName: RELEASE-NAME-metricbeat-daemonset-modules
      - name: data
        hostPath:
          path: /var/lib/metricbeat
          type: DirectoryOrCreate
      - name: proc
        hostPath:
          path: /proc
      - name: cgroup
        hostPath:
          path: /sys/fs/cgroup
      - name: dockersock
        hostPath:
          path: /var/run/docker.sock
      terminationGracePeriodSeconds: 60
      serviceAccountName: RELEASE-NAME-metricbeat
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      tolerations:
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule

---
# Source: metricbeat/templates/deployment.yaml
# Deploy singleton instance in the whole cluster for some unique data sources, like kube-state-metrics
apiVersion: apps/v1
kind: Deployment
metadata:
  name: RELEASE-NAME-metricbeat
  labels:
    app: metricbeat
    chart: metricbeat-0.4.0
    release: RELEASE-NAME
    heritage: Tiller
spec:
  selector:
    matchLabels:
      app: metricbeat
      release: RELEASE-NAME
  template:
    metadata:
      labels:
        app: metricbeat
        release: RELEASE-NAME
      annotations:
        checksum/modules: 33c3addf14d8a41ec0971a7e9a45844231265cfbdf8c3e5e81e0b8014f8e9741
        checksum/config: 10339e54ffd45e5b6103e4c2b0fb457137c7ee00e75fafa54316539b73fe02f4
    spec:
      serviceAccountName: RELEASE-NAME-metricbeat
      containers:
      - name: metricbeat
        image: "docker.elastic.co/beats/metricbeat:6.5.1"
        imagePullPolicy: IfNotPresent
        args:
        - "-e"
        env:
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        securityContext:
          runAsUser: 0
        resources:
          {}
          
        volumeMounts:
        - name: metricbeat-config
          mountPath: /usr/share/metricbeat/metricbeat.yml
          readOnly: true
          subPath: metricbeat.yml
        - name: modules
          mountPath: /usr/share/metricbeat/modules.d
          readOnly: true
      volumes:
      - name: metricbeat-config
        secret:
          secretName: RELEASE-NAME-metricbeat-deployment-config
      - name: modules
        secret:
          secretName: RELEASE-NAME-metricbeat-deployment-modules

